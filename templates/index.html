<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Bonita Control Center</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light;
        font-family: "Segoe UI", "Open Sans", Roboto, system-ui, sans-serif;
        background-color: #f5f7fb;
        color: #1f2933;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: #0a336d;
        color: #fff;
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
      }

      header h1 {
        font-size: 1.35rem;
        margin: 0;
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      header h1 span {
        font-weight: 300;
        opacity: 0.85;
      }

      .user-info {
        font-size: 0.9rem;
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .user-info button {
        background: #fff;
        color: #0a336d;
        border-radius: 6px;
        border: 1px solid #fff;
        padding: 0.4rem 0.8rem;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s, color 0.2s, opacity 0.2s;
      }

      .user-info button:hover {
        background: transparent;
        color: #fff;
        opacity: 0.85;
      }

      nav {
        background: #062651;
        padding: 0.5rem 2rem;
        display: flex;
        gap: 1rem;
      }

      nav button {
        background: transparent;
        border: none;
        color: #cbd5e1;
        font-weight: 600;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
      }

      nav button.active,
      nav button:hover {
        background: #fff;
        color: #062651;
      }

      nav[hidden] {
        display: none;
      }

      main {
        flex: 1;
        padding: 2rem;
        display: grid;
        gap: 1.5rem;
      }

      section.view {
        display: none;
      }

      section.view.active {
        display: block;
      }

      .card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(15, 23, 42, 0.08);
        overflow: hidden;
      }

      .card-header {
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, rgba(10, 51, 109, 0.92), rgba(58, 102, 182, 0.92));
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-header h2 {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 600;
        letter-spacing: 0.2px;
      }

      .card-body {
        padding: 1.25rem 1.5rem 1.75rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        font-size: 0.95rem;
      }

      th,
      td {
        text-align: left;
        padding: 0.75rem;
        border-bottom: 1px solid #edf1f7;
      }

      th {
        background: #f1f5fb;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        color: #4a5568;
      }

      tr:hover td {
        background: #f8fafc;
      }

      .actions {
        display: flex;
        gap: 0.5rem;
      }

      button.primary {
        background: #1d4ed8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.45rem 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.1s;
      }

      button.primary:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      button.secondary {
        background: #fff;
        color: #1d4ed8;
        border: 1px solid #1d4ed8;
        border-radius: 6px;
        padding: 0.45rem 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
      }

      button.secondary:hover {
        background: #1d4ed8;
        color: #fff;
      }

      form.inline {
        display: grid;
        gap: 0.75rem;
        margin-top: 1rem;
      }

      label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #1f2933;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 0.6rem 0.75rem;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        background: #fff;
      }

      textarea {
        min-height: 110px;
        font-family: inherit;
        resize: vertical;
      }

      .status-bar {
        background: #e0ecff;
        color: #1d4ed8;
        border-radius: 6px;
        padding: 0.6rem 0.75rem;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .status-bar.error {
        background: #fee2e2;
        color: #b91c1c;
      }

      .status-bar.success {
        background: #dcfce7;
        color: #166534;
      }

      .grid-two {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }

      #app-content[hidden] {
        display: none;
      }

      #auth-card form {
        display: grid;
        gap: 1rem;
      }

      #auth-card .credentials-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      #auth-card small {
        color: #475569;
      }

      @media (max-width: 768px) {
        header,
        nav {
          padding: 1rem;
        }

        main {
          padding: 1.25rem;
        }

        table {
          font-size: 0.88rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Bonita Control Center <span>FastAPI Prototype</span></h1>
      <div class="user-info">
        <span>Sesión: <strong id="session-user">Sin sesión</strong></span>
        <button id="logout-btn" hidden>Salir</button>
        <span id="last-sync">Sincronización pendiente…</span>
      </div>
    </header>

    <nav id="main-nav" hidden>
      <button class="tab-btn active" data-target="view-flows">Flujos</button>
      <button class="tab-btn" data-target="view-tasks">Tareas</button>
      <button class="tab-btn" data-target="view-cases">Casos</button>
    </nav>

    <main>
      <section class="card" id="auth-card">
        <div class="card-header">
          <h2>Autenticación en Bonita</h2>
        </div>
        <div class="card-body">
          <div id="auth-status" class="status-bar" hidden></div>
          <form id="login-form">
            <div class="credentials-grid">
              <div>
                <label for="login-username">Usuario</label>
                <input id="login-username" name="username" placeholder="ej: walter.bates" autocomplete="username" />
              </div>
              <div>
                <label for="login-password">Contraseña</label>
                <input id="login-password" name="password" type="password" placeholder="••••••" autocomplete="current-password" />
              </div>
            </div>
            <div class="actions">
              <button type="submit" class="primary">Iniciar sesión y obtener token</button>
              <button type="reset" class="secondary">Limpiar</button>
            </div>
            <small>
              El token JWT se conserva en la sesión actual del navegador. Cambia de usuario iniciando sesión nuevamente con credenciales distintas.
            </small>
          </form>
        </div>
      </section>

      <div id="app-content" hidden>
        <section id="view-flows" class="view active">
          <div class="card">
            <div class="card-header">
              <h2>Flujos semánticos disponibles</h2>
              <div class="actions">
                <button class="secondary" id="refresh-flows">Actualizar</button>
              </div>
            </div>
            <div class="card-body">
              <div id="flows-status" class="status-bar" hidden></div>
              <table id="flows-table">
                <thead>
                  <tr>
                    <th>Flujo</th>
                    <th>Disponible</th>
                    <th>Proceso Bonita</th>
                    <th>Versión</th>
                    <th>Process ID</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card" style="margin-top: 1.5rem;">
            <div class="card-header">
              <h2>Iniciar flujo</h2>
            </div>
            <div class="card-body">
              <div id="start-status" class="status-bar" hidden></div>
              <form class="inline" id="start-form">
                <div>
                  <label for="flow-select">Flujo</label>
                  <select id="flow-select">
                    <option value="">Selecciona un flujo disponible</option>
                  </select>
                </div>
                <div>
                  <label for="flow-variables">Contrato (JSON)</label>
                  <textarea
                    id="flow-variables"
                    placeholder='{"solicitud": "demo"}'
                  ></textarea>
                </div>
                <div class="actions">
                  <button type="submit" class="primary">Iniciar instancia</button>
                  <button type="reset" class="secondary">Limpiar</button>
                </div>
              </form>
            </div>
          </div>
        </section>

        <section id="view-tasks" class="view">
          <div class="card">
            <div class="card-header">
              <h2>Tareas pendientes para el usuario</h2>
              <div class="actions">
                <button class="secondary" id="refresh-tasks">Actualizar</button>
              </div>
            </div>
            <div class="card-body">
              <div id="tasks-status" class="status-bar" hidden></div>
              <table id="tasks-table">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Proceso</th>
                    <th>Estado</th>
                    <th>Asignado</th>
                    <th>ID</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="card" style="margin-top: 1.5rem; box-shadow: none; border: none;">
                <div class="card-body" style="padding: 0;">
                  <div id="task-action-status" class="status-bar" hidden></div>
                  <form class="inline" id="complete-form">
                    <h3>Completar tarea</h3>
                    <label for="complete-task-id">ID tarea</label>
                    <input id="complete-task-id" placeholder="ID numérico" />
                    <label for="complete-variables">Contrato (JSON)</label>
                    <textarea
                      id="complete-variables"
                      placeholder='{"aprobado": true}'
                    ></textarea>
                    <button type="submit" class="primary">Completar</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="view-cases" class="view">
          <div class="card">
            <div class="card-header">
              <h2>Estado de caso</h2>
            </div>
            <div class="card-body">
              <div id="case-status" class="status-bar" hidden></div>
              <form class="inline" id="case-form">
                <div>
                  <label for="case-id">ID de caso</label>
                  <input id="case-id" placeholder="Ej: 101" />
                </div>
                <div class="actions">
                  <button type="submit" class="primary">Consultar</button>
                  <button type="reset" class="secondary">Limpiar</button>
                </div>
              </form>

              <div style="margin-top: 1.5rem;">
                <h3>Detalle</h3>
                <pre id="case-output" style="background: #0b1733; color: #cbd5f5; padding: 1rem; border-radius: 8px; overflow-x: auto; min-height: 180px;"></pre>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <script>
      const tabButtons = document.querySelectorAll(".tab-btn");
      const views = document.querySelectorAll(".view");
      const navigation = document.getElementById("main-nav");

      const sessionUser = document.getElementById("session-user");
      const logoutBtn = document.getElementById("logout-btn");
      const lastSync = document.getElementById("last-sync");

      const loginForm = document.getElementById("login-form");
      const loginUsername = document.getElementById("login-username");
      const loginPassword = document.getElementById("login-password");
      const authStatus = document.getElementById("auth-status");
      const appContent = document.getElementById("app-content");

      const flowsTableBody = document.querySelector("#flows-table tbody");
      const flowsStatus = document.getElementById("flows-status");
      const flowSelect = document.getElementById("flow-select");
      const startStatus = document.getElementById("start-status");

      const tasksTableBody = document.querySelector("#tasks-table tbody");
      const tasksStatus = document.getElementById("tasks-status");
      const taskActionStatus = document.getElementById("task-action-status");

      const caseOutput = document.getElementById("case-output");
      const caseStatus = document.getElementById("case-status");

      let accessToken = "";
      let authenticatedUser = "";
      let cachedFlows = [];

      const activateTab = (targetId) => {
        tabButtons.forEach((button) => {
          const matchesTarget = button.dataset.target === targetId;
          button.classList.toggle("active", matchesTarget);
        });
        views.forEach((view) => {
          view.classList.toggle("active", view.id === targetId);
        });
      };

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          activateTab(btn.dataset.target);
        });
      });

      function setStatus(element, message, type = "info") {
        if (!element) return;
        element.hidden = false;
        element.textContent = message;
        element.classList.remove("error", "success");
        if (type === "error") {
          element.classList.add("error");
        } else if (type === "success") {
          element.classList.add("success");
        }
      }

      function clearStatus(element) {
        if (!element) return;
        element.hidden = true;
        element.textContent = "";
        element.classList.remove("error", "success");
      }

      function resetDataViews() {
        flowsTableBody.innerHTML = "";
        flowSelect.innerHTML = '<option value="">Selecciona un flujo disponible</option>';
        tasksTableBody.innerHTML = "";
        caseOutput.textContent = "";
        cachedFlows = [];
        clearStatus(flowsStatus);
        clearStatus(startStatus);
        clearStatus(tasksStatus);
        clearStatus(taskActionStatus);
        clearStatus(caseStatus);
      }

      function updateAuthUI() {
        const isAuthenticated = Boolean(accessToken);
        sessionUser.textContent = isAuthenticated ? authenticatedUser : "Sin sesión";
        logoutBtn.hidden = !isAuthenticated;
        navigation.hidden = !isAuthenticated;
        appContent.hidden = !isAuthenticated;
        if (!isAuthenticated) {
          lastSync.textContent = "Sincronización pendiente…";
          resetDataViews();
        }
      }

      function handleUnauthorized(message = "Sesión expirada. Inicia nuevamente.") {
        accessToken = "";
        authenticatedUser = "";
        updateAuthUI();
        setStatus(authStatus, message, "error");
      }

      async function callApi(url, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          ...(options.headers || {}),
        };
        if (accessToken) {
          headers.Authorization = `Bearer ${accessToken}`;
        }

        try {
          const response = await fetch(url, {
            ...options,
            headers,
          });

          if (!response.ok) {
            if (response.status === 401) {
              handleUnauthorized("Sesión no válida o expirada.");
            }
            const detailText = await response.text();
            let message = detailText || response.statusText;
            try {
              const parsed = JSON.parse(detailText);
              if (parsed && parsed.detail) {
                message = typeof parsed.detail === "string" ? parsed.detail : JSON.stringify(parsed.detail);
              } else if (parsed && parsed.message) {
                message = parsed.message;
              }
            } catch (_) {
              // respuesta en texto plano
            }
            throw new Error(message);
          }

          const text = await response.text();
          if (!text) return {};
          try {
            return JSON.parse(text);
          } catch (_) {
            return text;
          }
        } catch (error) {
          throw error;
        }
      }

      function renderFlows(flows) {
        flowsTableBody.innerHTML = "";
        flowSelect.innerHTML = '<option value="">Selecciona un flujo disponible</option>';

        flows.forEach((flow) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${flow.display_name}</td>
            <td>${flow.disponible ? "Sí" : "No"}</td>
            <td>${flow.bonita_process_name || "-"}</td>
            <td>${flow.bonita_version || "-"}</td>
            <td>${flow.bonita_process_id || "-"}</td>
            <td>
              <div class="actions">
                <button class="primary start-flow-btn" data-slug="${flow.slug}" ${flow.disponible ? "" : "disabled"}>
                  Iniciar
                </button>
              </div>
            </td>
          `;
          flowsTableBody.appendChild(row);

          if (flow.disponible) {
            const option = document.createElement("option");
            option.value = flow.slug;
            option.textContent = flow.display_name;
            flowSelect.appendChild(option);
          }
        });

        document.querySelectorAll(".start-flow-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            if (btn.disabled) return;
            clearStatus(startStatus);
            const slug = btn.dataset.slug;
            try {
              await startFlow(slug, {});
              setStatus(startStatus, `Instancia del flujo '${slug}' creada exitosamente.`, "success");
            } catch (error) {
              setStatus(startStatus, `Error iniciando flujo: ${error.message || error}`, "error");
            }
          });
        });
      }

      async function startFlow(flowSlug, contractPayload) {
        return callApi(`/api/flujos/${flowSlug}/iniciar`, {
          method: "POST",
          body: JSON.stringify({ contract_inputs: contractPayload }),
        });
      }

      function renderTasks(tasks) {
        tasksTableBody.innerHTML = "";
        tasks.forEach((task) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${task.display_name || task.name}</td>
            <td>${task.metadata?.processDefinitionId || task.metadata?.process_id || task.processDefinitionId || "N/D"}</td>
            <td>${task.state}</td>
            <td>${task.assigned_id || "-"}</td>
            <td>${task.id}</td>
            <td>
              <div class="actions">
                <button class="secondary prepare-task-btn" data-id="${task.id}">
                  Preparar
                </button>
              </div>
            </td>
          `;
          tasksTableBody.appendChild(row);
        });

        document.querySelectorAll(".prepare-task-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            document.getElementById("complete-task-id").value = btn.dataset.id;
            setStatus(taskActionStatus, `Listo para completar la tarea ${btn.dataset.id}`, "info");
            activateTab("view-tasks");
          });
        });
      }

      async function loadFlows() {
        setStatus(flowsStatus, "Consultando flujos…");
        try {
          const data = await callApi("/api/procesos-disponibles");
          cachedFlows = data;
          renderFlows(data);
          const disponibles = data.filter((flow) => flow.disponible).length;
          setStatus(flowsStatus, `Flujos configurados: ${disponibles}/${data.length}.`, "success");
          lastSync.textContent = `Última sincronización: ${new Date().toLocaleString()}`;
        } catch (error) {
          setStatus(flowsStatus, `Error al obtener flujos: ${error.message || error}`, "error");
        }
      }

      async function loadTasks() {
        setStatus(tasksStatus, "Consultando tareas pendientes…");
        try {
          const data = await callApi("/api/tareas/pendientes");
          renderTasks(data);
          setStatus(tasksStatus, `Tareas pendientes: ${data.length}.`, "success");
        } catch (error) {
          setStatus(tasksStatus, `Error al obtener tareas: ${error.message || error}`, "error");
        }
      }

      function initializeData() {
        loadFlows();
        loadTasks();
      }

      loginForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const username = loginUsername.value.trim();
        const password = loginPassword.value;

        if (!username || !password) {
          setStatus(authStatus, "Ingresa usuario y contraseña de Bonita.", "error");
          return;
        }

        setStatus(authStatus, "Autenticando con Bonita…");
        try {
          const formData = new URLSearchParams();
          formData.append("username", username);
          formData.append("password", password);

          const response = await fetch("/api/auth/token", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: formData.toString(),
          });

          if (!response.ok) {
            const detailText = await response.text();
            let message = detailText || "No se pudo autenticar.";
            try {
              const parsed = JSON.parse(detailText);
              if (parsed && parsed.detail) {
                message = typeof parsed.detail === "string" ? parsed.detail : JSON.stringify(parsed.detail);
              } else if (parsed && parsed.message) {
                message = parsed.message;
              }
            } catch (_) {
              // respuesta en texto plano
            }
            throw new Error(message);
          }

          const data = await response.json();
          accessToken = data.access_token;
          authenticatedUser = username;
          setStatus(authStatus, "Autenticación exitosa. Token activo.", "success");
          loginForm.reset();
          updateAuthUI();
          initializeData();
        } catch (error) {
          accessToken = "";
          authenticatedUser = "";
          updateAuthUI();
          setStatus(authStatus, `Error de autenticación: ${error.message || error}`, "error");
        }
      });

      loginForm.addEventListener("reset", () => {
        clearStatus(authStatus);
      });

      logoutBtn.addEventListener("click", (event) => {
        event.preventDefault();
        accessToken = "";
        authenticatedUser = "";
        updateAuthUI();
        setStatus(authStatus, "Sesión cerrada correctamente.", "info");
      });

      document.getElementById("refresh-flows").addEventListener("click", () => {
        if (!accessToken) {
          setStatus(authStatus, "Autentícate para consultar flujos.", "error");
          return;
        }
        loadFlows();
      });

      document.getElementById("refresh-tasks").addEventListener("click", () => {
        if (!accessToken) {
          setStatus(authStatus, "Autentícate para consultar tareas.", "error");
          return;
        }
        loadTasks();
      });

      document.getElementById("start-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!accessToken) {
          setStatus(authStatus, "Inicia sesión para operar con flujos.", "error");
          return;
        }

        const flowSlug = flowSelect.value;
        if (!flowSlug) {
          setStatus(startStatus, "Selecciona un flujo para continuar.", "error");
          return;
        }

        let contractPayload = {};
        const rawVariables = document.getElementById("flow-variables").value;
        if (rawVariables) {
          try {
            contractPayload = JSON.parse(rawVariables);
          } catch (_) {
            setStatus(startStatus, "El JSON del contrato no es válido.", "error");
            return;
          }
        }

        setStatus(startStatus, "Iniciando flujo…");
        try {
          const response = await startFlow(flowSlug, contractPayload);
          const caseId = response.case_id || response.metadata?.caseId || response.metadata?.case_id;
          setStatus(startStatus, `Instancia creada. Case ID: ${caseId || "desconocido"}.`, "success");
          event.target.reset();
          activateTab("view-tasks");
          loadTasks();
        } catch (error) {
          setStatus(startStatus, `Error al iniciar: ${error.message || error}`, "error");
        }
      });

      document.getElementById("start-form").addEventListener("reset", () => {
        clearStatus(startStatus);
      });

      document.getElementById("complete-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!accessToken) {
          setStatus(authStatus, "Inicia sesión para completar tareas.", "error");
          return;
        }
        const taskId = document.getElementById("complete-task-id").value.trim();
        if (!taskId) {
          setStatus(taskActionStatus, "Debes indicar el ID de la tarea.", "error");
          return;
        }

        let contractInputs = {};
        const rawVariables = document.getElementById("complete-variables").value;
        if (rawVariables) {
          try {
            contractInputs = JSON.parse(rawVariables);
          } catch (_) {
            setStatus(taskActionStatus, "El JSON del contrato no es válido.", "error");
            return;
          }
        }

        setStatus(taskActionStatus, `Completando tarea ${taskId}…`);
        try {
          await callApi(`/api/tareas/${taskId}/completar`, {
            method: "POST",
            body: JSON.stringify({
              contract_inputs: contractInputs,
            }),
          });
          setStatus(taskActionStatus, `Tarea ${taskId} completada.`, "success");
          loadTasks();
        } catch (error) {
          setStatus(taskActionStatus, `Error al completar: ${error.message || error}`, "error");
        }
      });

      document.getElementById("complete-form").addEventListener("reset", () => {
        clearStatus(taskActionStatus);
      });

      document.getElementById("case-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!accessToken) {
          setStatus(authStatus, "Autentícate para consultar casos.", "error");
          return;
        }
        const caseId = document.getElementById("case-id").value.trim();
        if (!caseId) {
          setStatus(caseStatus, "Debes indicar un ID de caso.", "error");
          return;
        }

        setStatus(caseStatus, "Consultando caso…");
        try {
          const result = await callApi(`/api/casos/${caseId}`);
          clearStatus(caseStatus);
          caseOutput.textContent = JSON.stringify(result, null, 2);
        } catch (error) {
          setStatus(caseStatus, `Error al consultar caso: ${error.message || error}`, "error");
          caseOutput.textContent = "";
        }
      });

      document.getElementById("case-form").addEventListener("reset", () => {
        clearStatus(caseStatus);
        caseOutput.textContent = "";
      });

      updateAuthUI();
    </script>
  </body>
</html>


